FROM rust:1.91.0-slim-bookworm AS stable-binary-provider

RUN rustup target add wasm32-wasip1 wasm32-wasip2

RUN apt update \
    && apt install -y --no-install-recommends \
        git \
        g++ \
        libssl-dev \
        pkg-config

# Clone a version of Spin with WASI OTel
RUN git clone --branch wasi-otel https://github.com/asteurer/spin \
    && cd spin \
    && git checkout cc558b2ec0cb2cd0619c6a410325bd165f632f1e

# Build Spin
RUN cd spin \
    && cargo build --release

FROM rust:1.91.0-slim-bookworm
COPY --from=stable-binary-provider /spin/target/release/spin /usr/local/bin

# Add compilation targets for building Spin apps
RUN rustup target add wasm32-wasip1 wasm32-wasip2

# Add integration test suite build dependencies
RUN apt update \
    && apt install -y --no-install-recommends \
        libssl-dev \
        pkg-config
